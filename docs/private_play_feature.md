# 包场功能说明

## 功能概述

包场功能允许管理员为特定时间段创建包场记录，在包场期间：
- 包场时间段内无法上机
- 包场当日全天（10点到次日10点）享受85折优惠
- 群名称会自动修改为"包场中"

## 命令列表

### 1. 查询当前上机人数
```
/uzj
```
- 功能：查询当前正在上机的用户数量
- 权限：所有用户

### 2. 查看包场信息
```
/uz 包场
```
- 功能：查看当前活跃的包场记录
- 权限：仅限管理员（status=896）
- 返回：包场ID、发起人、时间段、价格、备注等信息

### 3. 创建包场
```
/uz 包场 {qqNumber} {开始时间} {结束时间} {price} {remark}
```
- 功能：创建新的包场记录
- 权限：仅限管理员（status=896）
- 参数说明：
  - `qqNumber`: 发起人QQ号
  - `开始时间`: 格式为 "月-日-小时"，如 "7-30-14" 表示7月30日14点
  - `结束时间`: 格式为 "月-日-小时"，如 "7-30-22" 表示7月30日22点
  - `price`: 包场价格（元）
  - `remark`: 备注信息
- 示例：`/uz 包场 2164381071 7-30-14 7-30-22 460 包场`

### 4. 删除包场
```
/uz 包场 删除 {unique_id}
```
- 功能：删除指定的包场记录
- 权限：仅限管理员（status=896）
- 参数说明：
  - `unique_id`: 包场记录的唯一ID
- 示例：`/uz 包场 删除 1`

## 业务规则

### 包场期间限制
1. **时间段内无法上机**：包场时间段内普通用户无法使用 `/uz 上机` 命令
2. **当日全天折扣**：包场当日全天（10点到次日10点）享受85折优惠
3. **群名称修改**：包场开始时群名称改为"包场中"，结束后改为"씨발"

### 包场管理
1. **唯一性**：同一时间只能有一个活跃的包场
2. **懒加载检查**：每次上机时检查是否有活跃包场，避免定时任务开销
3. **权限控制**：只有管理员可以创建、查看、删除包场

### 折扣计算
- 包场当日：用户折扣 × 0.85（包场折扣，根据下机时间判断）
- 非包场当日：仅应用用户折扣

## 数据库表结构

### private_play_logs 表
```sql
CREATE TABLE private_play_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    unique_id SERIAL NOT NULL,
    qq_number TEXT NOT NULL,
    start_time TIMESTAMP WITH TIME ZONE NOT NULL,
    end_time TIMESTAMP WITH TIME ZONE NOT NULL,
    price DECIMAL(12,2) NOT NULL,
    remark TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE
);
```

## 懒加载机制

系统使用懒加载方式检查包场状态：
- 用户上机时检查是否有活跃包场
- 用户下机时检查包场折扣
- 避免定时任务对系统资源的开销

## 错误处理

常见错误消息：
- `❌ 权限不足，仅限管理员使用包场功能` - 非管理员尝试使用包场功能
- `❌ 当前处于包场时间段内，无法上机` - 包场时间段内尝试上机
- `❌ 当前已有活跃的包场，无法创建新的包场` - 尝试创建重复包场
- `❌ 时间格式错误，请使用格式：月-日-小时，如 7-30-14` - 时间格式错误
- `❌ 价格必须是正数` - 价格输入错误
- `❌ 未找到指定的包场记录` - 删除不存在的包场记录

## 使用示例

### 管理员创建包场
```
用户A: /uz 包场 2164381071 7-30-14 7-30-22 460 包场
机器人: 包场 (2164381071)开始:07-30 14:00结束:07-30 22:00 金额：460 remark：包场
```

### 查看包场信息
```
用户A: /uz 包场
机器人: 📋 当前活跃的包场记录：

🆔 包场ID: 1
👤 发起人: 2164381071
⏰ 开始时间: 2024-07-30 14:00:00
⏰ 结束时间: 2024-07-30 22:00:00
💰 价格: ¥460
📝 备注: 包场
```

### 普通用户尝试上机（包场时间段内）
```
用户B: /uz 上机
机器人: ❌ 当前处于包场时间段内，无法上机
```

### 普通用户上机（包场时间段外）
```
用户B: /uz 上机
机器人: 用户张三(123456789)：
上机计费开始，当前时间为2024-07-30 23:00:00
```

### 删除包场
```
用户A: /uz 包场 删除 1
机器人: ✅ 包场记录 1 已删除
```

## 时间格式说明

包场时间使用 `月-日-小时` 格式：
- `7-30-14` 表示 7月30日14点
- `12-25-20` 表示 12月25日20点
- 如果指定的日期已经过去，系统会自动设置为明年的同一天

## 包场逻辑说明

### 上机限制
- 包场时间段内：无法上机
- 包场时间段外：可以正常上机

### 折扣规则
- 包场当日（10点到次日10点）：根据下机时间判断是否享受85折
- 非包场当日：正常计费，无额外折扣

### 示例场景
假设包场时间为 7月30日 16:00-22:00：
- 7月30日 10:00-16:00：可以上机，享受85折
- 7月30日 16:00-22:00：无法上机
- 7月30日 22:00-次日10:00：可以上机，享受85折
- 7月31日 10:00后：可以上机，无额外折扣 